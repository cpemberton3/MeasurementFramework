---

groups: 

- name: Blackbox Alerts
   rules:
  - alert: PingFailed
    expr: probe_success == 0
    for: 0s
    labels:
      severity: critical
      responsible_primary: cscarp0


  - alert: Fabric Web Site Down
    expr: probe_success {job="blackbox-http", check_type="web-site"} == 0
    for: 5m
    labels: 
      severity: critical
    annotations:
      summary: "Web server {{ $lables.instance }} is down."
      description: "{{ $labels.instance }} has been down or not responding for more than 5 minutes."


- name: Rack Nodes Down Alerts
  rules: 
  - alert:
    expr: up { component_type~="head|worker" } == 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: {% raw %}Rack Node Exporter target missing (instance {{ $labels.instance }}){% endraw %}
      description: {% raw %}"A rack Node Exporter target has disappeared. An exporter might be crashed.\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"{% endraw %}


  - alert:
    expr: absent( up{ job="node", component_type~="head|worker" } ) == 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: {% raw %}Rack Node Exporter job is missing (instance {{ $labels.instance }}){% endraw %}
      description: {% raw %}"A rack Node Exporter job has disappeared. An exporter might be crashed.\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"{% endraw %}




  - name: Certificate Alerts
    rules:

    - alert: SSLCertExpired
      expr: (probe_ssl_earliest_cert_expiry - time()) < 0
      for: 15m
      labels:
        severity: critical

    - alert: SSLCertExpiringLessThan7Days
      expr: (probe_ssl_earliest_cert_expiry - time()) < (86400 * 7)
      for: 15m
      labels:
        severity: critical
        
    - alert: SSLCertExpiringLessThan30Days
      expr: (probe_ssl_earliest_cert_expiry - time()) < (86400 * 30)
      for: 15m
      labels:
        severity: warning
        
    - alert: SSLCertExpiringLessThan60Days
      expr: (probe_ssl_earliest_cert_expiry - time()) < (86400 * 60)
      for: 15m
      labels:
        severity: info
        
#    - alert: SSLCertExpiring11m2d
#      expr: (probe_ssl_earliest_cert_expiry - time()) < 28673600
#      for: 15m
#      labels:
#        severity: test


  - name: PTP Alerts
    rules: 
    
    - alert: RackNodeNotTimeSynced
      expr: node_timex_sync_status { component_type~="head|worker" } == 0 
      for: 15m
      labels:
        severity: error

    - alert: RackGPSTimeUnknown
      expr: tmiGPSTimeKnown  == 0
      for: 15m
      labels:
        severity: error

    - alert: 2DGPSFix
      expr: tmiGPSFix == 2
      for: 15m
      labels:
        severity: info

    - alert: NoGPSFix
      expr: tmiGPSFix == 0
      for: 15m
      labels: 
        severity: warning