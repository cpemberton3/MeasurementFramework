---

groups: 

- name: Blackbox Alerts
  #interval: 1m
  rules:

  - alert: VPN Ping Failed
    expr: probe_success {job="ping", reason="vpn"} == 0
    for: 1m
    labels:
      severity: warning
      fabric_system: vpn
    annotations:
      summary:  "VPN ping to {{ $labels.instance }} failed for 1 minute."   
      description:  "{{ $labels.instance }} did not respond to ping for 1 minute." 

  - alert: VPN Ping Failed
    expr: probe_success {job="ping", reason="vpn"} == 0
    for: 15m
    labels:
      severity: critical
      fabric_system: vpn 
    annotations:
      summary:  "VPN ping to {{ $labels.instance }} has failed for 15 minutes."   
      description:  "{{ $labels.instance }} has not responded to ping for more than 15 minutes." 

  - alert: HeadNodePingFailed
    expr: probe_success {job="ping", component_type="head", reason="infrastructure_check"} == 0
    for: 5m
    labels: 
      severity: error 
      fabric_system: headnode
    annotations: 
      summary: "Ping check, central metrics to headnode {{ $labels.subdomain }} on operations network ip {{ $labels.subdomain }} failed."
      description: "Ping check to see if headnode is up."

  - alert: WorkerNodePingFailed
    expr: probe_success {job="ping", component_type="worker", reason="infrastructure_check"} == 0
    for: 5m
    labels: 
      severity: error 
      fabric_system: headnode
    annotations: 
      summary: "Ping check, central metrics to worker node {{ $labels.subdomain }} on operations network ip {{ $labels.subdomain }} failed."
      description: "Ping check to see if worker node is up."

  - alert: Fabric Web Site Down
    expr: probe_success {job="blackbox-http", check_type="web-site"} == 0
    for: 5m
    labels: 
      severity: critical
      fabric_system: web_site
    annotations:
      summary:  "Web server {{ $labels.instance }} is down."   
      description:  "{{ $labels.instance }} has been down or not responding for more than 5 minutes." 

- name: Rack Node Exporter Down Alerts
  rules: 
  - alert: Rack Node Exporter Down
    expr: up { component_type=~"head|worker" } == 0
    for: 5m
    labels:
      severity: warning
      fabric_system: node_exporter
    annotations:
      summary:  "Rack Node Exporter target missing (instance {{ $labels.instance }})"   
      description:  "A rack Node Exporter target has disappeared. An exporter might be crashed.\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}" 
