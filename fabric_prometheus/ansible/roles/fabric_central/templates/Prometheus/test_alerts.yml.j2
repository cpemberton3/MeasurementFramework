---

groups: 

- name: Blackbox Alerts
  #interval: 1m
  rules:

  - alert: VPN Ping Failed
    expr: probe_success {job="ping", reason="vpn"} == 0
    for: 1m
    labels:
      severity: warning
      #responsible_primary: cscarp0
    annotations:
      summary: {% raw %}"VPN ping to {{ $labels.instance }} failed for 1 minute."{% endraw %}  
      description: {% raw %}"{{ $labels.instance }} did not respond to ping for 1 minute."{% endraw %}


  - alert: VPN Ping Failed
    expr: probe_success {job="ping", reason="vpn"} == 0
    for: 15m
    labels:
      severity: critical
      #responsible_primary: cscarp0
    annotations:
      summary: {% raw %}"VPN ping to {{ $labels.instance }} has failed for 15 minutes."{% endraw %}  
      description: {% raw %}"{{ $labels.instance }} has not responded to ping for more than 15 minutes."{% endraw %}



  - alert: Fabric Web Site Down
    expr: probe_success {job="blackbox-http", check_type="web-site"} == 0
    for: 5m
    labels: 
      severity: critical
    annotations:
      summary: {% raw %}"Web server {{ $labels.instance }} is down."{% endraw %}  
      description: {% raw %}"{{ $labels.instance }} has been down or not responding for more than 5 minutes."{% endraw %}


- name: Rack Nodes Down Alerts
  rules: 
  - alert: Rack Node Down
    expr: up { component_type=~"head|worker" } == 0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: {% raw %}"Rack Node Exporter target missing (instance {{ $labels.instance }})"{% endraw %}  
      description: {% raw %}"A rack Node Exporter target has disappeared. An exporter might be crashed.\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"{% endraw %}


  - alert: Rack node job missing
    expr: absent( up{ job="node", component_type=~"head|worker" } ) == 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: {% raw %}"Rack Node Exporter job is missing (instance {{ $labels.instance }})"{% endraw %}  
      description: {% raw %}"A rack Node Exporter job has disappeared. An exporter might be crashed.\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"{% endraw %}




- name: Certificate Alerts
  rules:

  - alert: SSLCertExpired
    expr: (probe_ssl_earliest_cert_expiry - time()) < 0
    for: 15m
    labels:
      severity: critical
    annotations:
      summary: {% raw %}"SSL Certificate has expired for {{ $labels.instance }}"{% endraw %}  
      description: {% raw %}"SSL Certificate has expired for {{ $labels.instance }}.\n  Seconds = {{ $value }}\n  LABELS = {{ $labels }}"{% endraw %}

  - alert: SSLCertExpiringLessThan7Days
    expr: (probe_ssl_earliest_cert_expiry - time()) < (86400 * 7)
    for: 15m
    labels:
      severity: critical
    annotations:
      summary: {% raw %}"SSL Certificate will expire in less than 7 days for {{ $labels.instance }}"{% endraw %}  
      description: {% raw %}"SSL Certificate will expire in less than 7 days for {{ $labels.instance }}.\n  Seconds = {{ $value }}\n  LABELS = {{ $labels }}"{% endraw %}
            
  - alert: SSLCertExpiringLessThan30Days
    expr: (probe_ssl_earliest_cert_expiry - time()) < (86400 * 30)
    for: 15m
    labels:
      severity: warning
    annotations:
      summary: {% raw %}"SSL Certificate will expire in less than 30 days for {{ $labels.instance }}"{% endraw %}  
      description: {% raw %}"SSL Certificate will expire in less than 30 days for {{ $labels.instance }}.\n  Seconds = {{ $value }}\n  LABELS = {{ $labels }}"{% endraw %}
       
  - alert: SSLCertExpiringLessThan60Days
    expr: (probe_ssl_earliest_cert_expiry - time()) < (86400 * 60)
    for: 15m
    labels:
      severity: info
    annotations:
      summary: {% raw %}"SSL Certificate will expire in less than 60 days for {{ $labels.instance }}"{% endraw %}  
      description: {% raw %}"SSL Certificate will expire in less than 60 days for {{ $labels.instance }}.\n  Seconds = {{ $value }}\n  LABELS = {{ $labels }}"{% endraw %}
      
#    - alert: SSLCertExpiring11m2d
#      expr: (probe_ssl_earliest_cert_expiry - time()) < 28673600
#      for: 15m
#      labels:
#        severity: test


- name: PTP Alerts
  rules: 
  
  - alert: RackNodeNotTimeSynced
    expr: node_timex_sync_status { component_type=~"head|worker" } == 0 
    for: 15m
    labels:
      severity: error

  - alert: RackGPSTimeUnknown
    expr: tmiGPSTimeKnown  == 0
    for: 15m
    labels:
      severity: error

  - alert: 2DGPSFix
    expr: tmiGPSFix == 2
    for: 15m
    labels:
      severity: info

  - alert: NoGPSFix
    expr: tmiGPSFix == 0
    for: 15m
    labels: 
      severity: warning