---

# Create temporary SSH key pair for ansible
- hosts: localhost
  connection: local
  tasks:
  - name: generate SSH key
    openssh_keypair:
      path: ~/.ssh/ansible
      type: rsa
      size: 4096
      state: present
      # force: yes # Recreate key 
      force: no # Reuse key

- hosts: all
  become: true
  tasks:  
  # Create ansible user on remote hosts
  - name: Create ansible user
    user:
      name: ansible
      group: root

  # Add ssh public key to remote hosts
  - name: Add public ssh key for ansible user
    authorized_key:
      user: ansible
      key: "{{ lookup('file', '~/.ssh/ansible.pub') }}"
      state: present

  # Make ansible account sudo
  - name: Add sudoers file for ansible
    copy:
      src: sudoer_ansible
      dest: /etc/sudoers.d/ansible
      owner: root
      group: root
      mode: 0440


- hosts: Measurement
  become: true
  tasks:  
  # Copy private ssh key to Measurement node only
  - name: Copy created private ssh key to Measurement node
    copy:
      src: ~/.ssh/ansible
      dest: /home/ansible/.ssh/ansible
      owner: ansible
      mode: 0600

  # Install packages (ansible on Measurement node)
  - name: Installing packages
    tags: packages
    yum:
      name:
        - epel-release
        - gcc
        - openssl-devel
        - bzip2-devel
        - libffi-devel
        - centos-release-scl
        - yum-utils
        - ansible
        - git
        - httpd-tools
        - lvm2
        - device-mapper-persistent-data
      state: latest
      update_cache: yes
