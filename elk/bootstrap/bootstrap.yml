---
# Create temporary SSH key pair for ansible
- hosts: localhost
  connection: local
  tasks:
    - name: generate SSH key
      openssh_keypair:
        path: ~/.ssh/ansible
        type: rsa
        size: 4096
        state: present
        # force: yes # Recreate key
        force: no # Reuse key

- hosts: all
  become: true
  pre_tasks:
    - name: Install updates (CentOS)
      tags: always
      yum:
        update_only: yes
        update_cache: yes
      when: ansible_distribution == "CentOS"

  tasks:
    # Create ansible user on remote hosts
    - name: Create ansible user
      user:
        name: ansible
        group: root

    # Add ssh public key to remote hosts
    - name: Add public ssh key for ansible user
      authorized_key:
        user: ansible
        key: "{{ lookup('file', '~/.ssh/ansible.pub') }}"
        state: present

    # Make ansible account sudo
    - name: Add sudoers file for ansible
      copy:
        src: sudoer_ansible
        dest: /etc/sudoers.d/ansible
        owner: root
        group: root
        mode: 0440

- hosts: Measurement_Node
  tasks:
    # Copy private ssh key to Measurement node only
    - name: Copy created private ssh key to Measurement node
      become: true
      copy:
        src: ~/.ssh/ansible
        dest: /home/ansible/.ssh/ansible
        owner: ansible
        mode: 0600

    # Install packages (ansible on Measurement node)
    - name: Installing packages
      become: true
      tags: packages
      yum:
        name:
          - epel-release
          - gcc
          - openssl-devel
          - bzip2-devel
          - libffi-devel
          - centos-release-scl
          - yum-utils
          - ansible
          - git
          - httpd-tools
          - lvm2
          - device-mapper-persistent-data
        state: latest
        update_cache: yes

    # Check if mf git repo are already created
    - name: Check if mf git repo folders already exists
      become: true
      become_user: ansible
      tags: mfgitrepo
      stat:
        path: /home/ansible/mf_git
      register: r_mf_git_folder_exist

    # Clone MF git repo dev branch
    - name: Clone mf git repo
      become: true
      become_user: ansible
      tags: mfgitrepo
      git:
        repo: https://github.com/fabric-testbed/MeasurementFramework.git
        dest: /home/ansible/mf_git
        version: dev
      when: r_mf_git_folder_exist.stat.exists == false

    # Copy host file
    - name: Update host file
      become_user: ansible
      tags: updatehostfile
      copy:
        src: ../hosts
        dest: /home/ansible/mf_git/elk/hosts
        mode: 0644
